{% extends "v2/base.html" %}

{% block title %}Create Schedule - ScriptFlow{% endblock %}

{% block page_title %}Create Schedule{% endblock %}
{% block page_subtitle %}Set up automated script execution{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('schedules') }}" class="text-decoration-none">
                            <i class="bi bi-calendar me-2"></i>Schedules
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Create Schedule</li>
                </ol>
            </nav>

            <!-- Create Form -->
            <div class="row justify-content-center">
                <div class="col-xl-10">
                    <form method="POST">
                        <!-- Basic Settings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-gear me-2"></i>
                                    Basic Settings
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Script Selection -->
                                    <div class="col-md-6 mb-3">
                                        <label for="script_search" class="form-label">
                                            Script <span class="text-danger">*</span>
                                        </label>
                                        <div class="position-relative">
                                            <input 
                                                type="text" 
                                                id="script_search" 
                                                class="form-control"
                                                placeholder="Type to search scripts..." 
                                                autocomplete="off">
                                            <input type="hidden" id="script_id" name="script_id" required>
                                            <div id="script_dropdown" class="position-absolute w-100 mt-1 bg-white border rounded shadow-sm" style="z-index: 1000; max-height: 15rem; overflow-y: auto; display: none;">
                                                {% for script in scripts %}
                                                <div class="script-option d-flex align-items-center p-3 border-bottom cursor-pointer" 
                                                     data-value="{{ script.id }}"
                                                     data-name="{{ script.name.lower() }}"
                                                     data-type="{{ script.script_type.lower() }}"
                                                     style="cursor: pointer;">
                                                    <span class="badge bg-primary me-3">
                                                        {{ script.script_type.upper() }}
                                                    </span>
                                                    <div>
                                                        <div class="fw-medium">{{ script.name }}</div>
                                                        {% if script.description %}
                                                        <div class="text-muted small">{{ script.description[:60] }}{% if script.description|length > 60 %}...{% endif %}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Schedule Name -->
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">
                                            Schedule Name <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            id="name" 
                                            name="name" 
                                            class="form-control"
                                            placeholder="e.g., Daily Backup" 
                                            required>
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea 
                                        id="description" 
                                        name="description" 
                                        rows="3" 
                                        class="form-control"
                                        placeholder="Optional description of what this schedule does..."></textarea>
                                </div>

                                <!-- Active Toggle -->
                                <div class="form-check">
                                    <input type="checkbox" id="is_active" name="is_active" checked class="form-check-input">
                                    <label for="is_active" class="form-check-label">
                                        Active Schedule
                                        <small class="d-block text-muted">Enable this schedule to run automatically</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Pattern -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-event me-2"></i>
                                    Schedule Pattern
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Frequency Selection -->
                                <div class="mb-4">
                                    <label class="form-label">
                                        Frequency <span class="text-danger">*</span>
                                    </label>
                                    <div class="row">
                                        <div class="col-md-3 col-6 mb-2">
                                            <div class="form-check">
                                                <input type="radio" name="frequency" value="daily" checked class="form-check-input" id="freq_daily">
                                                <label class="form-check-label w-100 p-2 border rounded d-flex align-items-center" for="freq_daily" style="cursor: pointer;">
                                                    <i class="bi bi-calendar-day me-2 text-primary"></i>
                                                    <span>Daily</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6 mb-2">
                                            <div class="form-check">
                                                <input type="radio" name="frequency" value="weekly" class="form-check-input" id="freq_weekly">
                                                <label class="form-check-label w-100 p-2 border rounded d-flex align-items-center" for="freq_weekly" style="cursor: pointer;">
                                                    <i class="bi bi-calendar-week me-2 text-primary"></i>
                                                    <span>Weekly</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6 mb-2">
                                            <div class="form-check">
                                                <input type="radio" name="frequency" value="monthly" class="form-check-input" id="freq_monthly">
                                                <label class="form-check-label w-100 p-2 border rounded d-flex align-items-center" for="freq_monthly" style="cursor: pointer;">
                                                    <i class="bi bi-calendar-month me-2 text-primary"></i>
                                                    <span>Monthly</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6 mb-2">
                                            <div class="form-check">
                                                <input type="radio" name="frequency" value="interval" class="form-check-input" id="freq_interval">
                                                <label class="form-check-label w-100 p-2 border rounded d-flex align-items-center" for="freq_interval" style="cursor: pointer;">
                                                    <i class="bi bi-clock me-2 text-primary"></i>
                                                    <span>Interval</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Time and Date Settings -->
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="time" class="form-label">
                                            Time <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="time" 
                                            id="time" 
                                            name="time" 
                                            value="09:00" 
                                            class="form-control"
                                            required>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label for="start_date" class="form-label">Start Date</label>
                                        <input 
                                            type="date" 
                                            id="start_date" 
                                            name="start_date" 
                                            class="form-control">
                                        <small class="text-muted">Leave empty to start today</small>
                                    </div>
                                    
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Quick Start</label>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" onclick="setStartDate('today')" class="btn btn-outline-secondary btn-sm">Today</button>
                                            <button type="button" onclick="setStartDate('tomorrow')" class="btn btn-outline-secondary btn-sm">Tomorrow</button>
                                            <button type="button" onclick="setStartDate('next_week')" class="btn btn-outline-secondary btn-sm">Next Week</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weekly Options -->
                                <div id="weekly_options" class="mb-3" style="display: none;">
                                    <label class="form-label">
                                        Days of Week <span class="text-danger">*</span>
                                    </label>
                                    <div class="row">
                                        <div class="col-sm-6 col-lg-3 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" name="days" value="monday" checked class="form-check-input" id="day_mon">
                                                <label class="form-check-label w-100 text-center p-2 border rounded" for="day_mon" style="cursor: pointer;">Mon</label>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" name="days" value="tuesday" class="form-check-input" id="day_tue">
                                                <label class="form-check-label w-100 text-center p-2 border rounded" for="day_tue" style="cursor: pointer;">Tue</label>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" name="days" value="wednesday" class="form-check-input" id="day_wed">
                                                <label class="form-check-label w-100 text-center p-2 border rounded" for="day_wed" style="cursor: pointer;">Wed</label>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" name="days" value="thursday" class="form-check-input" id="day_thu">
                                                <label class="form-check-label w-100 text-center p-2 border rounded" for="day_thu" style="cursor: pointer;">Thu</label>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" name="days" value="friday" class="form-check-input" id="day_fri">
                                                <label class="form-check-label w-100 text-center p-2 border rounded" for="day_fri" style="cursor: pointer;">Fri</label>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" name="days" value="saturday" class="form-check-input" id="day_sat">
                                                <label class="form-check-label w-100 text-center p-2 border rounded" for="day_sat" style="cursor: pointer;">Sat</label>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 col-lg-3 mb-2">
                                            <div class="form-check">
                                                <input type="checkbox" name="days" value="sunday" class="form-check-input" id="day_sun">
                                                <label class="form-check-label w-100 text-center p-2 border rounded" for="day_sun" style="cursor: pointer;">Sun</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Monthly Options -->
                                <div id="monthly_options" class="mb-3" style="display: none;">
                                    <div class="col-md-4">
                                        <label for="day" class="form-label">
                                            Day of Month <span class="text-danger">*</span>
                                        </label>
                                        <input 
                                            type="number" 
                                            id="day" 
                                            name="day" 
                                            value="1" 
                                            min="1" 
                                            max="28" 
                                            class="form-control">
                                        <small class="text-muted">Day 1-28 (to avoid month-end issues)</small>
                                    </div>
                                </div>

                                <!-- Interval Options -->
                                <div id="interval_options" class="mb-3" style="display: none;">
                                    <div class="col-md-4">
                                        <label for="interval_minutes" class="form-label">
                                            Interval <span class="text-danger">*</span>
                                        </label>
                                        <select id="interval_minutes" name="interval_minutes" class="form-select">
                                            <option value="1">Every 1 minute</option>
                                            <option value="5">Every 5 minutes</option>
                                            <option value="10">Every 10 minutes</option>
                                            <option value="15" selected>Every 15 minutes</option>
                                            <option value="20">Every 20 minutes</option>
                                            <option value="30">Every 30 minutes</option>
                                            <option value="60">Every 1 hour</option>
                                        </select>
                                        <small class="text-muted">Script will run continuously at this interval</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Schedule Preview -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Schedule Preview
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-0">
                                    <p id="schedule_preview" class="mb-0 fw-medium">
                                        This schedule will run daily at 09:00
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex gap-3 mb-4">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-plus-circle me-2"></i>
                                Create Schedule
                            </button>
                            <a href="{{ url_for('schedules') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Script search functionality
    const searchInput = document.getElementById('script_search');
    const dropdown = document.getElementById('script_dropdown');
    const hiddenInput = document.getElementById('script_id');
    const options = document.querySelectorAll('.script-option');
    
    let selectedValue = '';
    let selectedText = '';
    
    // Show dropdown on focus
    searchInput.addEventListener('focus', function() {
        dropdown.style.display = 'block';
        if (!this.value) {
            resetFilter();
        }
    });
    
    // Filter options as user types
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (this.value !== selectedText) {
            selectedValue = '';
            hiddenInput.value = '';
        }
        
        filterOptions(query);
        dropdown.style.display = 'block';
    });
    
    // Handle script selection
    options.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const value = this.dataset.value;
            const scriptName = this.querySelector('.fw-medium').textContent;
            const scriptType = this.dataset.type.toUpperCase();
            
            selectedValue = value;
            selectedText = `[${scriptType}] ${scriptName}`;
            
            searchInput.value = selectedText;
            hiddenInput.value = value;
            
            dropdown.style.display = 'none';
            updateScheduleName(scriptName);
            
            // Visual feedback
            searchInput.classList.add('border-success', 'bg-light');
            setTimeout(() => {
                searchInput.classList.remove('border-success', 'bg-light');
            }, 2000);
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.closest('div').contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    function filterOptions(query) {
        options.forEach(option => {
            const name = option.dataset.name;
            const type = option.dataset.type;
            const description = option.textContent.toLowerCase();
            
            const matches = !query || 
                           name.includes(query) || 
                           type.includes(query) || 
                           description.includes(query);
            
            option.style.display = matches ? 'block' : 'none';
        });
    }
    
    function resetFilter() {
        options.forEach(option => {
            option.style.display = 'block';
        });
    }
    
    function updateScheduleName(scriptName) {
        const nameField = document.getElementById('name');
        if (!nameField.value && scriptName) {
            const frequency = document.querySelector('input[name="frequency"]:checked').value;
            const frequencyName = frequency.charAt(0).toUpperCase() + frequency.slice(1);
            nameField.value = `${frequencyName} ${scriptName}`;
        }
    }
    
    // Frequency changes
    document.addEventListener('change', function(e) {
        if (e.target.name === 'frequency') {
            updateFrequencyOptions();
            updatePreview();
        }
        if (e.target.name === 'days' || e.target.name === 'time' || e.target.id === 'day' || 
            e.target.id === 'start_date' || e.target.id === 'interval_minutes') {
            updatePreview();
        }
    });
    
    function updateFrequencyOptions() {
        const frequency = document.querySelector('input[name="frequency"]:checked').value;
        const weeklyOptions = document.getElementById('weekly_options');
        const monthlyOptions = document.getElementById('monthly_options');
        const intervalOptions = document.getElementById('interval_options');
        
        weeklyOptions.style.display = 'none';
        monthlyOptions.style.display = 'none';
        intervalOptions.style.display = 'none';
        
        if (frequency === 'weekly') {
            weeklyOptions.style.display = 'block';
        } else if (frequency === 'monthly') {
            monthlyOptions.style.display = 'block';
        } else if (frequency === 'interval') {
            intervalOptions.style.display = 'block';
        }
    }
    
    function updatePreview() {
        const frequency = document.querySelector('input[name="frequency"]:checked').value;
        const time = document.getElementById('time').value;
        const startDate = document.getElementById('start_date').value;
        const preview = document.getElementById('schedule_preview');
        
        let previewText = '';
        let startText = '';
        
        if (startDate) {
            const startDateObj = new Date(startDate + 'T00:00:00');
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            const todayStr = today.toISOString().split('T')[0];
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            if (startDate === todayStr) {
                startText = ' starting today';
            } else if (startDate === tomorrowStr) {
                startText = ' starting tomorrow';
            } else {
                startText = ` starting ${startDateObj.toLocaleDateString()}`;
            }
        }
        
        if (frequency === 'daily') {
            previewText = `This schedule will run daily at ${time}${startText}`;
        } else if (frequency === 'weekly') {
            const checkedDays = Array.from(document.querySelectorAll('input[name="days"]:checked'))
                .map(cb => cb.value)
                .map(day => day.charAt(0).toUpperCase() + day.slice(1));
            
            if (checkedDays.length === 0) {
                previewText = 'Please select at least one day of the week';
            } else if (checkedDays.length === 1) {
                previewText = `This schedule will run every ${checkedDays[0]} at ${time}${startText}`;
            } else {
                previewText = `This schedule will run on ${checkedDays.join(', ')} at ${time}${startText}`;
            }
        } else if (frequency === 'monthly') {
            const day = document.getElementById('day').value || '1';
            const suffix = getDaySuffix(day);
            previewText = `This schedule will run on the ${day}${suffix} of each month at ${time}${startText}`;
        } else if (frequency === 'interval') {
            const intervalMinutes = document.getElementById('interval_minutes').value || '15';
            let intervalText = intervalMinutes === '60' ? 'every hour' : `every ${intervalMinutes} minutes`;
            let timeText = startDate || time !== '09:00' ? ` beginning at ${time}` : '';
            previewText = `This schedule will run ${intervalText}${timeText}${startText}`;
        }
        
        preview.textContent = previewText;
    }
    
    function getDaySuffix(day) {
        const j = day % 10;
        const k = day % 100;
        
        if (j == 1 && k != 11) return 'st';
        if (j == 2 && k != 12) return 'nd';
        if (j == 3 && k != 13) return 'rd';
        return 'th';
    }
    
    // Initialize
    updateFrequencyOptions();
    updatePreview();
});

// Start date helper functions
function setStartDate(type) {
    const startDateField = document.getElementById('start_date');
    const today = new Date();
    
    function formatDateForInput(date) {
        return date.toISOString().split('T')[0];
    }
    
    switch(type) {
        case 'today':
            startDateField.value = formatDateForInput(today);
            break;
        case 'tomorrow':
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            startDateField.value = formatDateForInput(tomorrow);
            break;
        case 'next_week':
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            startDateField.value = formatDateForInput(nextWeek);
            break;
    }
    
    // Trigger preview update
    startDateField.dispatchEvent(new Event('change'));
}

// Style updates for form checks
document.querySelectorAll('input[name="frequency"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // Update visual state for frequency selection
        document.querySelectorAll('label[for^="freq_"]').forEach(label => {
            label.classList.remove('border-primary', 'bg-light');
        });
        
        if (this.checked) {
            document.querySelector(`label[for="${this.id}"]`).classList.add('border-primary', 'bg-light');
        }
    });
});

// Initialize first frequency selection
document.querySelector('input[name="frequency"]:checked').dispatchEvent(new Event('change'));
</script>

<style>
.script-option:hover {
    background-color: var(--bs-gray-100);
}

input[name="frequency"]:checked + label {
    border-color: var(--bs-primary) !important;
    background-color: var(--bs-light) !important;
}

input[name="days"]:checked + label {
    border-color: var(--bs-primary) !important;
    background-color: var(--bs-light) !important;
}
</style>
{% endblock %}