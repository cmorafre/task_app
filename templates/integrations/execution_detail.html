{% extends "base.html" %}

{% block title %}Execution Details - {{ execution.integration.name }} - ScriptFlow{% endblock %}

{% block content %}
<!-- Action Bar -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1 fw-semibold">Execution Details</h5>
                    <p class="text-muted mb-0 small">{{ execution.integration.name }} - {{ execution.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                </div>
                <div class="d-flex gap-2">
                    {% if execution.status == 'running' %}
                    <button class="btn btn-outline-warning btn-sm" onclick="cancelExecution({{ execution.id }})">
                        <i class="bi bi-stop me-1"></i>Cancel
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshPage()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                    <a href="/integrations/executions" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Executions
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status and Overview -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="modern-card">
            <div class="d-flex align-items-center mb-3">
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                    <i class="bi bi-diagram-3 text-primary fs-4"></i>
                </div>
                <div>
                    <h6 class="mb-0 fw-semibold">{{ execution.integration.name }}</h6>
                    <p class="text-muted mb-0 small">Integration Execution #{{ execution.id }}</p>
                </div>
                <div class="ms-auto">
                    {% if execution.status == 'running' %}
                    <span class="badge bg-info fs-6">
                        <i class="bi bi-arrow-repeat me-1"></i>Running
                    </span>
                    {% elif execution.status == 'completed' %}
                    <span class="badge bg-success fs-6">
                        <i class="bi bi-check-circle me-1"></i>Completed
                    </span>
                    {% elif execution.status == 'failed' %}
                    <span class="badge bg-danger fs-6">
                        <i class="bi bi-x-circle me-1"></i>Failed
                    </span>
                    {% elif execution.status == 'cancelled' %}
                    <span class="badge bg-warning fs-6">
                        <i class="bi bi-dash-circle me-1"></i>Cancelled
                    </span>
                    {% else %}
                    <span class="badge bg-secondary fs-6">{{ execution.status|title }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="bg-light p-3 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Started At</span>
                            <i class="bi bi-play-circle text-muted"></i>
                        </div>
                        <div class="fw-medium">{{ execution.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                        <small class="text-muted">{{ execution.started_at.strftime('%A, %B %d') }}</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="bg-light p-3 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Duration</span>
                            <i class="bi bi-clock text-muted"></i>
                        </div>
                        {% if execution.completed_at %}
                            {% set duration = (execution.completed_at - execution.started_at).total_seconds() %}
                            <div class="fw-medium">
                                {% if duration < 60 %}
                                    {{ "%.1f"|format(duration) }} seconds
                                {% elif duration < 3600 %}
                                    {{ "%.1f"|format(duration/60) }} minutes
                                {% else %}
                                    {{ "%.1f"|format(duration/3600) }} hours
                                {% endif %}
                            </div>
                            <small class="text-muted">Completed at {{ execution.completed_at.strftime('%H:%M:%S') }}</small>
                        {% elif execution.status == 'running' %}
                            <div class="fw-medium text-info">
                                <span id="runningDuration">Calculating...</span>
                            </div>
                            <small class="text-muted">Currently running</small>
                        {% else %}
                            <div class="fw-medium text-muted">-</div>
                            <small class="text-muted">Not completed</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="modern-card">
            <h6 class="mb-3 fw-semibold">
                <i class="bi bi-bar-chart me-2"></i>Statistics
            </h6>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">Records Processed</span>
                    <span class="fw-medium">{{ execution.records_processed if execution.records_processed is not none else '-' }}</span>
                </div>
                <div class="progress" style="height: 6px;">
                    {% if execution.records_processed and execution.records_processed > 0 %}
                    <div class="progress-bar bg-success" style="width: 100%"></div>
                    {% endif %}
                </div>
            </div>
            
            {% if execution.records_failed and execution.records_failed > 0 %}
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small text-danger">Records Failed</span>
                    <span class="fw-medium text-danger">{{ execution.records_failed }}</span>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-danger" style="width: 100%"></div>
                </div>
            </div>
            {% endif %}
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="small">Trigger Type</span>
                    {% if execution.trigger_type %}
                    <span class="badge bg-light text-dark">
                        {% if execution.trigger_type.value == 'manual' %}
                            <i class="bi bi-hand-index me-1"></i>Manual
                        {% elif execution.trigger_type.value == 'scheduled' %}
                            <i class="bi bi-calendar3 me-1"></i>Scheduled
                        {% elif execution.trigger_type.value == 'api' %}
                            <i class="bi bi-code me-1"></i>API
                        {% else %}
                            {{ execution.trigger_type.value|title }}
                        {% endif %}
                    </span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </div>
            </div>
            
            {% if execution.user %}
            <div>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="small">Executed By</span>
                    <span class="fw-medium">{{ execution.user.username }}</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Integration Details -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="d-flex align-items-center mb-3">
                <div class="bg-info bg-opacity-10 p-2 rounded-circle me-3">
                    <i class="bi bi-info-circle text-info"></i>
                </div>
                <h6 class="mb-0 fw-semibold">Integration Configuration</h6>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small fw-medium text-muted">Source Database</label>
                        <div class="p-2 bg-light rounded">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-database me-2 text-primary"></i>
                                <div>
                                    <div class="fw-medium">{{ execution.integration.source.name }}</div>
                                    <small class="text-muted">{{ execution.integration.source.db_type|upper }} - {{ execution.integration.source.host }}:{{ execution.integration.source.port }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small fw-medium text-muted">Target Database</label>
                        <div class="p-2 bg-light rounded">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-database me-2 text-success"></i>
                                <div>
                                    <div class="fw-medium">{{ execution.integration.target.name }}</div>
                                    <small class="text-muted">{{ execution.integration.target.db_type|upper }} - {{ execution.integration.target.host }}:{{ execution.integration.target.port }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if execution.integration.python_script %}
            <div class="mb-3">
                <label class="form-label small fw-medium text-muted">Transformation Script</label>
                <div class="p-2 bg-light rounded">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-code me-2 text-warning"></i>
                        <div>
                            <div class="fw-medium">{{ execution.integration.python_script.name }}</div>
                            <small class="text-muted">Python transformation script</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Execution Log -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="d-flex align-items-center">
                    <div class="bg-secondary bg-opacity-10 p-2 rounded-circle me-3">
                        <i class="bi bi-terminal text-secondary"></i>
                    </div>
                    <h6 class="mb-0 fw-semibold">Execution Log</h6>
                </div>
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleLogExpand()">
                    <i class="bi bi-arrows-expand me-1"></i>Expand
                </button>
            </div>
            
            {% if execution.log_output %}
            <div class="bg-dark text-light p-3 rounded" style="font-family: 'Courier New', monospace; font-size: 0.875rem; max-height: 400px; overflow-y: auto;" id="executionLog">
                <pre class="mb-0">{{ execution.log_output }}</pre>
            </div>
            {% else %}
            <div class="text-center py-4 text-muted">
                <i class="bi bi-file-text fs-2 mb-2"></i>
                <p class="mb-0">No log output available</p>
                {% if execution.status == 'running' %}
                <small>Log output will appear as the execution progresses</small>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Error Details (if any) -->
{% if execution.error_message %}
<div class="row">
    <div class="col-12">
        <div class="modern-card border-danger">
            <div class="d-flex align-items-center mb-3">
                <div class="bg-danger bg-opacity-10 p-2 rounded-circle me-3">
                    <i class="bi bi-exclamation-triangle text-danger"></i>
                </div>
                <h6 class="mb-0 fw-semibold text-danger">Error Details</h6>
            </div>
            
            <div class="alert alert-danger">
                <strong>Error Message:</strong><br>
                <code>{{ execution.error_message }}</code>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    function refreshPage() {
        window.location.reload();
    }

    function cancelExecution(executionId) {
        if (!confirm('Cancel this execution? This action cannot be undone.')) {
            return;
        }

        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Cancelling...';
        btn.disabled = true;

        fetch(`/integrations/executions/${executionId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Execution cancelled successfully');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('danger', data.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        })
        .catch(error => {
            showAlert('danger', 'Failed to cancel execution: ' + error.message);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
    }

    function toggleLogExpand() {
        const log = document.getElementById('executionLog');
        const btn = event.target.closest('button');
        
        if (log.style.maxHeight === '400px' || !log.style.maxHeight) {
            log.style.maxHeight = 'none';
            btn.innerHTML = '<i class="bi bi-arrows-collapse me-1"></i>Collapse';
        } else {
            log.style.maxHeight = '400px';
            btn.innerHTML = '<i class="bi bi-arrows-expand me-1"></i>Expand';
        }
    }

    function updateRunningDuration() {
        const startTime = new Date('{{ execution.started_at.isoformat() }}');
        const now = new Date();
        const diff = (now - startTime) / 1000; // seconds
        
        let duration;
        if (diff < 60) {
            duration = diff.toFixed(1) + ' seconds';
        } else if (diff < 3600) {
            duration = (diff / 60).toFixed(1) + ' minutes';
        } else {
            duration = (diff / 3600).toFixed(1) + ' hours';
        }
        
        const element = document.getElementById('runningDuration');
        if (element) {
            element.textContent = duration;
        }
    }

    function showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.content-area').prepend(alert);
        
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    // Auto-refresh for running executions
    {% if execution.status == 'running' %}
    function autoRefresh() {
        updateRunningDuration();
        setTimeout(() => {
            window.location.reload();
        }, 15000); // Refresh every 15 seconds
    }

    // Update duration every second for running executions
    setInterval(updateRunningDuration, 1000);
    
    document.addEventListener('DOMContentLoaded', function() {
        updateRunningDuration();
        setTimeout(autoRefresh, 15000);
    });
    {% endif %}
</script>
{% endblock %}