{% extends "base.html" %}

{% block page_title %}Web Terminal{% endblock %}
{% block page_subtitle %}Execute commands and manage packages for script execution{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('main.settings') }}" class="text-decoration-none">
                <i class="bi bi-gear me-2"></i>Settings
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Web Terminal</li>
    </ol>
</nav>

<!-- Quick Commands Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="modern-card">
            <div class="d-flex align-items-center mb-3">
                <div class="bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                    <i class="bi bi-lightning-fill text-primary fs-4"></i>
                </div>
                <div>
                    <h5 class="mb-0 fw-semibold">Quick Commands</h5>
                    <p class="text-muted mb-0 small">Common package management and system commands</p>
                </div>
            </div>
            
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="runCommand('pip list')">
                    <i class="bi bi-list-ul me-1"></i>List Packages
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="runCommand('pip install speedtest-cli')">
                    <i class="bi bi-download me-1"></i>Install speedtest-cli
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="runCommand('pip install pandas')">
                    <i class="bi bi-download me-1"></i>Install pandas
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="runCommand('pip install openpyxl')">
                    <i class="bi bi-download me-1"></i>Install openpyxl
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="runCommand('which python')">
                    <i class="bi bi-search me-1"></i>Which Python
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearTerminal()">
                    <i class="bi bi-eraser me-1"></i>Clear
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Terminal Section -->
<div class="row">
    <div class="col-12">
        <div class="modern-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <div class="bg-dark bg-opacity-10 p-2 rounded-circle me-3">
                        <i class="bi bi-terminal text-dark"></i>
                    </div>
                    <div>
                        <h5 class="mb-0 fw-semibold">Terminal</h5>
                        <p class="text-muted mb-0 small">Interactive command line interface</p>
                    </div>
                </div>
                <div class="d-flex gap-1">
                    <div class="terminal-button bg-danger"></div>
                    <div class="terminal-button bg-warning"></div>
                    <div class="terminal-button bg-success"></div>
                </div>
            </div>

            <!-- Terminal Display -->
            <div class="terminal-container">
                <div class="terminal" id="terminal">
                    <div class="terminal-line">
                        <span class="terminal-prompt">scriptflow@terminal:~$</span> 
                        <span class="terminal-output">Web Terminal Ready. Type your commands below.</span>
                    </div>
                    <div class="terminal-line">
                        <span class="terminal-output">Allowed commands: pip, python, which, ls, pwd</span>
                    </div>
                    <div class="terminal-line">
                        <span class="terminal-prompt">scriptflow@terminal:~$</span> 
                        <input type="text" class="terminal-input" id="commandInput" 
                               placeholder="Type command and press Enter..." autofocus>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Security Notice -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-shield-check me-3 fs-4"></i>
            <div>
                <div class="fw-semibold">Security Information</div>
                <div class="small">Only safe package management and system information commands are allowed for security purposes.</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .terminal-button {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
    
    .terminal-container {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .terminal { 
        background-color: #1e1e1e; 
        color: #d4d4d4; 
        padding: 20px; 
        font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Courier New', monospace; 
        font-size: 14px;
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        line-height: 1.5;
    }
    
    .terminal-input { 
        background: transparent; 
        border: none; 
        color: #d4d4d4; 
        outline: none; 
        width: 100%;
        font-family: inherit;
        font-size: inherit;
    }
    
    .terminal-line { 
        margin: 4px 0; 
        word-wrap: break-word;
    }
    
    .terminal-prompt { 
        color: #4ec9b0; 
        font-weight: 600;
    }
    
    .terminal-command { 
        color: #9cdcfe; 
    }
    
    .terminal-output { 
        color: #d4d4d4; 
    }
    
    .terminal-error { 
        color: #f44747; 
    }
    
    .modern-card {
        transition: all 0.3s ease;
    }
    
    .modern-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    .btn {
        transition: all 0.2s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
    }
    
    /* Terminal scrollbar styling */
    .terminal::-webkit-scrollbar {
        width: 8px;
    }
    
    .terminal::-webkit-scrollbar-track {
        background: #2d2d2d;
    }
    
    .terminal::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 4px;
    }
    
    .terminal::-webkit-scrollbar-thumb:hover {
        background: #777;
    }
    
    /* Alert styling */
    .alert-info {
        background-color: hsl(210 40% 98%);
        border-color: hsl(210 40% 90%);
        color: hsl(215.4 16.3% 46.9%);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
const terminal = document.getElementById('terminal');
const commandInput = document.getElementById('commandInput');

commandInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const command = this.value.trim();
        if (command) {
            runCommand(command);
            this.value = '';
        }
    }
});

function runCommand(command) {
    // Show command in terminal
    addTerminalLine('terminal-prompt', `scriptflow@terminal:~$ ${command}`);
    addTerminalLine('terminal-output', 'Executing...');
    
    fetch('/api/terminal/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: command })
    })
    .then(response => response.json())
    .then(data => {
        // Remove "Executing..." line
        terminal.removeChild(terminal.lastElementChild);
        
        if (data.error) {
            addTerminalLine('terminal-error', `Error: ${data.error}`);
        } else {
            if (data.stdout) {
                data.stdout.split('\n').forEach(line => {
                    if (line.trim()) addTerminalLine('terminal-output', line);
                });
            }
            if (data.stderr) {
                data.stderr.split('\n').forEach(line => {
                    if (line.trim()) addTerminalLine('terminal-error', line);
                });
            }
            if (!data.stdout && !data.stderr) {
                addTerminalLine('terminal-output', 'Command completed successfully.');
            }
        }
        
        // Add new prompt
        addPrompt();
    })
    .catch(error => {
        // Remove "Executing..." line
        terminal.removeChild(terminal.lastElementChild);
        addTerminalLine('terminal-error', `Network error: ${error.message}`);
        addPrompt();
    });
}

function addTerminalLine(className, text) {
    const line = document.createElement('div');
    line.className = `terminal-line ${className}`;
    line.textContent = text;
    
    // Insert before the input line
    const inputLine = terminal.lastElementChild;
    terminal.insertBefore(line, inputLine);
    
    // Scroll to bottom
    terminal.scrollTop = terminal.scrollHeight;
}

function addPrompt() {
    // Remove current input line
    terminal.removeChild(terminal.lastElementChild);
    
    // Add new prompt with input
    const promptLine = document.createElement('div');
    promptLine.className = 'terminal-line';
    promptLine.innerHTML = `
        <span class="terminal-prompt">scriptflow@terminal:~$</span> 
        <input type="text" class="terminal-input" placeholder="Type command..." autofocus>
    `;
    
    terminal.appendChild(promptLine);
    
    // Focus new input
    const newInput = promptLine.querySelector('.terminal-input');
    newInput.focus();
    
    // Add event listener
    newInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const command = this.value.trim();
            if (command) {
                runCommand(command);
            }
        }
    });
    
    terminal.scrollTop = terminal.scrollHeight;
}

function clearTerminal() {
    terminal.innerHTML = `
        <div class="terminal-line">
            <span class="terminal-prompt">scriptflow@terminal:~$</span> 
            <span class="terminal-output">Terminal cleared.</span>
        </div>
        <div class="terminal-line">
            <span class="terminal-prompt">scriptflow@terminal:~$</span> 
            <input type="text" class="terminal-input" placeholder="Type command..." autofocus>
        </div>
    `;
    
    // Re-add event listener to new input
    const newInput = terminal.querySelector('.terminal-input');
    newInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const command = this.value.trim();
            if (command) {
                runCommand(command);
            }
        }
    });
    newInput.focus();
    
    terminal.scrollTop = terminal.scrollHeight;
}

// Initialize terminal focus
document.addEventListener('DOMContentLoaded', function() {
    commandInput.focus();
});
</script>
{% endblock %}