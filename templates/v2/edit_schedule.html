{% extends "v2/base.html" %}

{% block title %}Edit Schedule - ScriptFlow{% endblock %}

{% block page_title %}Edit Schedule{% endblock %}
{% block page_subtitle %}Modify {{ schedule.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('schedules') }}" class="text-decoration-none">
                            <i class="bi bi-calendar3 me-2"></i>Schedules
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Edit {{ schedule.name }}</li>
                </ol>
            </nav>

            <!-- Schedule Status Card -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Current Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">{{ schedule.name }}</h6>
                            <div class="d-flex gap-2">
                                {% if schedule.is_active %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle me-1"></i>Active
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle me-1"></i>Inactive
                                    </span>
                                {% endif %}
                                <span class="badge bg-info">{{ schedule.frequency.title() }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">Schedule ID: #{{ schedule.id }}</small><br>
                            <small class="text-muted">Created: {{ schedule.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Form -->
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card">
                        <div class="card-body">
                            <form method="POST">
                                <!-- Basic Settings -->
                                <div class="mb-4">
                                    <h5 class="card-title">
                                        <i class="bi bi-gear me-2"></i>Basic Settings
                                    </h5>
                                    <hr>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="script_id" class="form-label">Script *</label>
                                            <select class="form-select" id="script_id" name="script_id" required>
                                                {% for script in scripts %}
                                                <option value="{{ script.id }}" {% if script.id == schedule.script_id %}selected{% endif %}>
                                                    [{{ script.script_type.upper() }}] {{ script.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Schedule Name *</label>
                                            <input type="text" class="form-control" id="name" name="name" value="{{ schedule.name }}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Optional description of what this schedule does...">{{ schedule.description or '' }}</textarea>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if schedule.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="is_active">
                                            <strong>Active Schedule</strong>
                                            <small class="d-block text-muted">Enable this schedule to run automatically</small>
                                        </label>
                                    </div>
                                </div>

                                <!-- Schedule Pattern -->
                                <div class="mb-4">
                                    <h5 class="card-title">
                                        <i class="bi bi-calendar3 me-2"></i>Schedule Pattern
                                    </h5>
                                    <hr>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Frequency *</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" id="frequency_daily" value="daily" {% if schedule.frequency == 'daily' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_daily">
                                                    <i class="bi bi-calendar-day me-1"></i>Daily
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" id="frequency_weekly" value="weekly" {% if schedule.frequency == 'weekly' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_weekly">
                                                    <i class="bi bi-calendar-week me-1"></i>Weekly
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" id="frequency_monthly" value="monthly" {% if schedule.frequency == 'monthly' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_monthly">
                                                    <i class="bi bi-calendar-month me-1"></i>Monthly
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" id="frequency_interval" value="interval" {% if schedule.frequency == 'interval' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_interval">
                                                    <i class="bi bi-clock me-1"></i>Interval
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="time" class="form-label">Time *</label>
                                            <input type="time" class="form-control" id="time" name="time" value="{{ schedule.time or '09:00' }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="start_date" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ schedule.start_date.strftime('%Y-%m-%d') if schedule.start_date else '' }}">
                                            <small class="text-muted">Leave empty to start today</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Quick Start</label>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setStartDate('today')">Today</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setStartDate('tomorrow')">Tomorrow</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setStartDate('next_week')">Next Week</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weekly Options -->
                                <div id="weekly_options" class="mb-3" style="display: {% if schedule.frequency == 'weekly' %}block{% else %}none{% endif %};">
                                    <label class="form-label">Days of Week *</label>
                                    {% set days_list = schedule.days.split(',') if schedule.days else [] %}
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" value="monday" id="day_monday" {% if 'monday' in days_list %}checked{% endif %}>
                                                <label class="form-check-label" for="day_monday">Mon</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" value="tuesday" id="day_tuesday" {% if 'tuesday' in days_list %}checked{% endif %}>
                                                <label class="form-check-label" for="day_tuesday">Tue</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" value="wednesday" id="day_wednesday" {% if 'wednesday' in days_list %}checked{% endif %}>
                                                <label class="form-check-label" for="day_wednesday">Wed</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" value="thursday" id="day_thursday" {% if 'thursday' in days_list %}checked{% endif %}>
                                                <label class="form-check-label" for="day_thursday">Thu</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" value="friday" id="day_friday" {% if 'friday' in days_list %}checked{% endif %}>
                                                <label class="form-check-label" for="day_friday">Fri</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" value="saturday" id="day_saturday" {% if 'saturday' in days_list %}checked{% endif %}>
                                                <label class="form-check-label" for="day_saturday">Sat</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" value="sunday" id="day_sunday" {% if 'sunday' in days_list %}checked{% endif %}>
                                                <label class="form-check-label" for="day_sunday">Sun</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Monthly Options -->
                                <div id="monthly_options" class="mb-3" style="display: {% if schedule.frequency == 'monthly' %}block{% else %}none{% endif %};">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="day" class="form-label">Day of Month *</label>
                                            <input type="number" class="form-control" id="day" name="day" value="{{ schedule.day or 1 }}" min="1" max="28">
                                            <small class="text-muted">Day 1-28 (to avoid month-end issues)</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Interval Options -->
                                <div id="interval_options" class="mb-3" style="display: {% if schedule.frequency == 'interval' %}block{% else %}none{% endif %};">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="interval_minutes" class="form-label">Interval *</label>
                                            <select class="form-control" id="interval_minutes" name="interval_minutes">
                                                <option value="1" {% if schedule.interval_minutes == 1 %}selected{% endif %}>Every 1 minute</option>
                                                <option value="5" {% if schedule.interval_minutes == 5 %}selected{% endif %}>Every 5 minutes</option>
                                                <option value="10" {% if schedule.interval_minutes == 10 %}selected{% endif %}>Every 10 minutes</option>
                                                <option value="15" {% if schedule.interval_minutes == 15 %}selected{% endif %}>Every 15 minutes</option>
                                                <option value="20" {% if schedule.interval_minutes == 20 %}selected{% endif %}>Every 20 minutes</option>
                                                <option value="30" {% if schedule.interval_minutes == 30 %}selected{% endif %}>Every 30 minutes</option>
                                                <option value="60" {% if schedule.interval_minutes == 60 %}selected{% endif %}>Every 1 hour</option>
                                            </select>
                                            <small class="text-muted">Script will run continuously at this interval</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Schedule Preview -->
                                <div class="mb-4">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-info-circle me-2"></i>Schedule Preview
                                        </h6>
                                        <p class="mb-0" id="schedule_preview">
                                            This schedule will run daily at 09:00
                                        </p>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-check-lg me-2"></i>Save Changes
                                    </button>
                                    <a href="{{ url_for('schedules') }}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left me-2"></i>Back to Schedules
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle frequency changes
document.addEventListener('change', function(e) {
    if (e.target.name === 'frequency') {
        updateFrequencyOptions();
        updatePreview();
    }
    if (e.target.name === 'days' || e.target.name === 'time' || e.target.id === 'day' || 
        e.target.id === 'start_date' || e.target.id === 'interval_minutes') {
        updatePreview();
    }
});

function updateFrequencyOptions() {
    const frequency = document.querySelector('input[name="frequency"]:checked').value;
    const weeklyOptions = document.getElementById('weekly_options');
    const monthlyOptions = document.getElementById('monthly_options');
    const intervalOptions = document.getElementById('interval_options');
    
    weeklyOptions.style.display = 'none';
    monthlyOptions.style.display = 'none';
    intervalOptions.style.display = 'none';
    
    if (frequency === 'weekly') {
        weeklyOptions.style.display = 'block';
    } else if (frequency === 'monthly') {
        monthlyOptions.style.display = 'block';
    } else if (frequency === 'interval') {
        intervalOptions.style.display = 'block';
    }
}

function updatePreview() {
    const frequency = document.querySelector('input[name="frequency"]:checked').value;
    const time = document.getElementById('time').value;
    const startDate = document.getElementById('start_date').value;
    const preview = document.getElementById('schedule_preview');
    
    let previewText = '';
    let startText = '';
    
    if (startDate) {
        const startDateObj = new Date(startDate + 'T00:00:00');
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        
        const todayStr = today.toISOString().split('T')[0];
        const tomorrowStr = tomorrow.toISOString().split('T')[0];
        
        if (startDate === todayStr) {
            startText = ' starting today';
        } else if (startDate === tomorrowStr) {
            startText = ' starting tomorrow';
        } else {
            startText = ` starting ${startDateObj.toLocaleDateString()}`;
        }
    }
    
    if (frequency === 'daily') {
        previewText = `This schedule will run daily at ${time}${startText}`;
    } else if (frequency === 'weekly') {
        const checkedDays = Array.from(document.querySelectorAll('input[name="days"]:checked'))
            .map(cb => cb.value)
            .map(day => day.charAt(0).toUpperCase() + day.slice(1));
        
        if (checkedDays.length === 0) {
            previewText = 'Please select at least one day of the week';
        } else if (checkedDays.length === 1) {
            previewText = `This schedule will run every ${checkedDays[0]} at ${time}${startText}`;
        } else {
            previewText = `This schedule will run on ${checkedDays.join(', ')} at ${time}${startText}`;
        }
    } else if (frequency === 'monthly') {
        const day = document.getElementById('day').value || '1';
        const suffix = getDaySuffix(day);
        previewText = `This schedule will run on the ${day}${suffix} of each month at ${time}${startText}`;
    } else if (frequency === 'interval') {
        const intervalMinutes = document.getElementById('interval_minutes').value || '15';
        let intervalText = intervalMinutes === '60' ? 'every hour' : `every ${intervalMinutes} minutes`;
        let timeText = startDate || time !== '09:00' ? ` beginning at ${time}` : '';
        previewText = `This schedule will run ${intervalText}${timeText}${startText}`;
    }
    
    preview.textContent = previewText;
}

function getDaySuffix(day) {
    const j = day % 10;
    const k = day % 100;
    
    if (j == 1 && k != 11) return 'st';
    if (j == 2 && k != 12) return 'nd';
    if (j == 3 && k != 13) return 'rd';
    return 'th';
}

// Start date helper functions
function setStartDate(type) {
    const startDateField = document.getElementById('start_date');
    const today = new Date();
    
    function formatDateForInput(date) {
        return date.toISOString().split('T')[0];
    }
    
    switch(type) {
        case 'today':
            startDateField.value = formatDateForInput(today);
            break;
        case 'tomorrow':
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            startDateField.value = formatDateForInput(tomorrow);
            break;
        case 'next_week':
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            startDateField.value = formatDateForInput(nextWeek);
            break;
    }
    
    updatePreview();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFrequencyOptions();
    updatePreview();
});
</script>
{% endblock %}