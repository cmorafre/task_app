{% extends "base.html" %}

{% block title %}Terminal{% endblock %}

{% block extra_css %}
<style>
    .terminal { 
        background-color: #1e1e1e; 
        color: #d4d4d4; 
        padding: 20px; 
        border-radius: 8px; 
        font-family: 'Monaco', 'Courier New', monospace; 
        font-size: 14px;
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
    }
    .terminal-input { 
        background: transparent; 
        border: none; 
        color: #d4d4d4; 
        outline: none; 
        width: 100%;
        font-family: inherit;
    }
    .terminal-line { margin: 2px 0; }
    .terminal-prompt { color: #4ec9b0; }
    .terminal-command { color: #9cdcfe; }
    .terminal-output { color: #d4d4d4; }
    .terminal-error { color: #f44747; }
    .quick-commands { margin-bottom: 20px; }
</style>
{% endblock %}

{% block content %}
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('settings') }}">Settings</a></li>
                        <li class="breadcrumb-item active">Terminal</li>
                    </ol>
                </nav>
                <h1><i class="bi bi-terminal me-2"></i>Package Manager Terminal</h1>
                <p class="text-muted">Install packages and manage dependencies for script execution</p>
            </div>
        </div>

        <div class="quick-commands">
            <h5>Quick Commands:</h5>
            <div class="btn-group flex-wrap" role="group">
                <button class="btn btn-outline-primary btn-sm" onclick="runCommand('pip list')">
                    List Packages
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="runCommand('pip install speedtest-cli')">
                    Install speedtest-cli
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="runCommand('pip install pandas')">
                    Install pandas
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="runCommand('pip install openpyxl')">
                    Install openpyxl
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="runCommand('which python')">
                    Which Python
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearTerminal()">
                    Clear
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body p-0">
                <div class="terminal" id="terminal">
                    <div class="terminal-line">
                        <span class="terminal-prompt">scriptflow@terminal:~$</span> 
                        <span class="terminal-output">Web Terminal Ready. Type your commands below.</span>
                    </div>
                    <div class="terminal-line">
                        <span class="terminal-output">Allowed commands: pip, python, which, ls, pwd</span>
                    </div>
                    <div class="terminal-line">
                        <span class="terminal-prompt">scriptflow@terminal:~$</span> 
                        <input type="text" class="terminal-input" id="commandInput" 
                               placeholder="Type command and press Enter..." autofocus>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Security Note: Only safe package management and system information commands are allowed.
            </small>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const terminal = document.getElementById('terminal');
        const commandInput = document.getElementById('commandInput');
        
        commandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const command = this.value.trim();
                if (command) {
                    runCommand(command);
                    this.value = '';
                }
            }
        });

        function runCommand(command) {
            // Show command in terminal
            addTerminalLine('terminal-prompt', `scriptflow@terminal:~$ ${command}`);
            addTerminalLine('terminal-output', 'Executing...');
            
            fetch('/api/terminal/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: command })
            })
            .then(response => response.json())
            .then(data => {
                // Remove "Executing..." line
                terminal.removeChild(terminal.lastElementChild);
                
                if (data.error) {
                    addTerminalLine('terminal-error', `Error: ${data.error}`);
                } else {
                    if (data.stdout) {
                        data.stdout.split('\n').forEach(line => {
                            if (line.trim()) addTerminalLine('terminal-output', line);
                        });
                    }
                    if (data.stderr) {
                        data.stderr.split('\n').forEach(line => {
                            if (line.trim()) addTerminalLine('terminal-error', line);
                        });
                    }
                    if (!data.stdout && !data.stderr) {
                        addTerminalLine('terminal-output', 'Command completed successfully.');
                    }
                }
                
                // Add new prompt
                addPrompt();
            })
            .catch(error => {
                // Remove "Executing..." line
                terminal.removeChild(terminal.lastElementChild);
                addTerminalLine('terminal-error', `Network error: ${error.message}`);
                addPrompt();
            });
        }

        function addTerminalLine(className, text) {
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            
            // Insert before the input line
            const inputLine = terminal.lastElementChild;
            terminal.insertBefore(line, inputLine);
            
            // Scroll to bottom
            terminal.scrollTop = terminal.scrollHeight;
        }

        function addPrompt() {
            // Remove current input line
            terminal.removeChild(terminal.lastElementChild);
            
            // Add new prompt with input
            const promptLine = document.createElement('div');
            promptLine.className = 'terminal-line';
            promptLine.innerHTML = `
                <span class="terminal-prompt">scriptflow@terminal:~$</span> 
                <input type="text" class="terminal-input" placeholder="Type command..." autofocus>
            `;
            
            terminal.appendChild(promptLine);
            
            // Focus new input
            const newInput = promptLine.querySelector('.terminal-input');
            newInput.focus();
            
            // Add event listener
            newInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const command = this.value.trim();
                    if (command) {
                        runCommand(command);
                    }
                }
            });
            
            terminal.scrollTop = terminal.scrollHeight;
        }

        function clearTerminal() {
            terminal.innerHTML = `
                <div class="terminal-line">
                    <span class="terminal-prompt">scriptflow@terminal:~$</span> 
                    <span class="terminal-output">Terminal cleared.</span>
                </div>
                <div class="terminal-line">
                    <span class="terminal-prompt">scriptflow@terminal:~$</span> 
                    <input type="text" class="terminal-input" placeholder="Type command..." autofocus>
                </div>
            `;
            
            // Re-add event listener to new input
            const newInput = terminal.querySelector('.terminal-input');
            newInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const command = this.value.trim();
                    if (command) {
                        runCommand(command);
                    }
                }
            });
            newInput.focus();
        }
    </script>
</body>
</html>