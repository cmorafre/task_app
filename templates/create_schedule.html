{% extends "base.html" %}

{% block title %}Create Schedule - ScriptFlow{% endblock %}

{% block extra_css %}
<style>
    /* Script search dropdown styles */
    .dropdown-menu {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    .dropdown-item.script-option {
        cursor: pointer;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .dropdown-item.script-option:last-child {
        border-bottom: none;
    }
    
    .dropdown-item.script-option:hover {
        background-color: #f8f9fa;
    }
    
    .dropdown-item.script-option:active {
        background-color: #e9ecef;
    }
    
    /* Quick start buttons */
    .btn-outline-secondary.btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Create New Schedule</h1>
                    <p class="text-muted">Set up automated script execution</p>
                </div>
                <a href="{{ url_for('schedules') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Schedules
                </a>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <form method="POST">
                                <!-- Basic Settings -->
                                <div class="mb-4">
                                    <h5 class="card-title">
                                        <i class="bi bi-gear me-2"></i>Basic Settings
                                    </h5>
                                    <hr>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="script_id" class="form-label">Script *</label>
                                            <div class="position-relative">
                                                <input type="text" class="form-control" id="script_search" 
                                                       placeholder="Type to search scripts..." 
                                                       autocomplete="off">
                                                <select class="form-select" id="script_id" name="script_id" required style="display: none;">
                                                    <option value="">Select a script...</option>
                                                    {% for script in scripts %}
                                                    <option value="{{ script.id }}" 
                                                            data-name="{{ script.name.lower() }}"
                                                            data-type="{{ script.script_type.upper() }}">
                                                        [{{ script.script_type.upper() }}] {{ script.name }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <div id="script_dropdown" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto;">
                                                    {% for script in scripts %}
                                                    <div class="dropdown-item script-option" data-value="{{ script.id }}">
                                                        <span class="badge bg-info me-2">{{ script.script_type.upper() }}</span>
                                                        {{ script.name }}
                                                        {% if script.description %}
                                                        <br><small class="text-muted">{{ script.description[:50] }}{% if script.description|length > 50 %}...{% endif %}</small>
                                                        {% endif %}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Schedule Name *</label>
                                            <input type="text" class="form-control" id="name" name="name" 
                                                   placeholder="e.g., Daily Backup" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"
                                              placeholder="Optional description of what this schedule does..."></textarea>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                        <label class="form-check-label" for="is_active">
                                            <strong>Active Schedule</strong>
                                            <small class="d-block text-muted">Enable this schedule to run automatically</small>
                                        </label>
                                    </div>
                                </div>

                                <!-- Schedule Pattern -->
                                <div class="mb-4">
                                    <h5 class="card-title">
                                        <i class="bi bi-calendar3 me-2"></i>Schedule Pattern
                                    </h5>
                                    <hr>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Frequency *</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" 
                                                       id="frequency_daily" value="daily" checked>
                                                <label class="form-check-label" for="frequency_daily">
                                                    <i class="bi bi-calendar-day me-1"></i>Daily
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" 
                                                       id="frequency_weekly" value="weekly">
                                                <label class="form-check-label" for="frequency_weekly">
                                                    <i class="bi bi-calendar-week me-1"></i>Weekly
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" 
                                                       id="frequency_monthly" value="monthly">
                                                <label class="form-check-label" for="frequency_monthly">
                                                    <i class="bi bi-calendar-month me-1"></i>Monthly
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="time" class="form-label">Time *</label>
                                            <input type="time" class="form-control" id="time" name="time" value="09:00" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="start_date" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="start_date" name="start_date">
                                            <small class="text-muted">Leave empty to start today</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Quick Start</label>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setStartDate('today')">Today</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setStartDate('tomorrow')">Tomorrow</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setStartDate('next_week')">Next Week</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weekly Options -->
                                <div id="weekly_options" class="mb-3" style="display: none;">
                                    <label class="form-label">Days of Week *</label>
                                    <div class="row">
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="monday" id="day_monday" checked>
                                                <label class="form-check-label" for="day_monday">Mon</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="tuesday" id="day_tuesday">
                                                <label class="form-check-label" for="day_tuesday">Tue</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="wednesday" id="day_wednesday">
                                                <label class="form-check-label" for="day_wednesday">Wed</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="thursday" id="day_thursday">
                                                <label class="form-check-label" for="day_thursday">Thu</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="friday" id="day_friday">
                                                <label class="form-check-label" for="day_friday">Fri</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="saturday" id="day_saturday">
                                                <label class="form-check-label" for="day_saturday">Sat</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="sunday" id="day_sunday">
                                                <label class="form-check-label" for="day_sunday">Sun</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Monthly Options -->
                                <div id="monthly_options" class="mb-3" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="day" class="form-label">Day of Month *</label>
                                            <input type="number" class="form-control" id="day" name="day" 
                                                   value="1" min="1" max="28">
                                            <small class="text-muted">Day 1-28 (to avoid month-end issues)</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Preview Section -->
                                <div class="mb-4">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-info-circle me-2"></i>Schedule Preview
                                        </h6>
                                        <p class="mb-0" id="schedule_preview">
                                            This schedule will run daily at 09:00
                                        </p>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-calendar-plus me-2"></i>Create Schedule
                                    </button>
                                    <a href="{{ url_for('schedules') }}" class="btn btn-outline-secondary">
                                        Cancel
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle frequency changes
document.addEventListener('change', function(e) {
    if (e.target.name === 'frequency') {
        updateFrequencyOptions();
        updatePreview();
    }
    if (e.target.name === 'days' || e.target.name === 'time' || e.target.id === 'day' || e.target.id === 'start_date') {
        updatePreview();
    }
});

// Script search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('script_search');
    const dropdown = document.getElementById('script_dropdown');
    const hiddenSelect = document.getElementById('script_id');
    const options = document.querySelectorAll('.script-option');
    
    let selectedValue = '';
    let isDropdownOpen = false;
    
    // Show dropdown on focus
    searchInput.addEventListener('focus', function() {
        showDropdown();
    });
    
    // Filter options on input
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        let hasVisibleOptions = false;
        
        options.forEach(option => {
            const text = option.textContent.toLowerCase();
            if (text.includes(query)) {
                option.style.display = 'block';
                hasVisibleOptions = true;
            } else {
                option.style.display = 'none';
            }
        });
        
        if (hasVisibleOptions) {
            showDropdown();
        } else {
            hideDropdown();
        }
    });
    
    // Handle option selection
    options.forEach(option => {
        option.addEventListener('click', function() {
            const value = this.dataset.value;
            const text = this.textContent.trim();
            
            searchInput.value = text;
            hiddenSelect.value = value;
            selectedValue = value;
            
            hideDropdown();
            updateScheduleName();
        });
    });
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideDropdown();
        }
    });
    
    function showDropdown() {
        dropdown.classList.add('show');
        isDropdownOpen = true;
        
        // Reset all options to visible when opening
        options.forEach(option => {
            option.style.display = 'block';
        });
    }
    
    function hideDropdown() {
        dropdown.classList.remove('show');
        isDropdownOpen = false;
    }
    
    function updateScheduleName() {
        const nameField = document.getElementById('name');
        if (!nameField.value && selectedValue) {
            const selectedOption = document.querySelector(`option[value="${selectedValue}"]`);
            if (selectedOption) {
                const scriptName = selectedOption.textContent.split('] ')[1];
                const frequency = document.querySelector('input[name="frequency"]:checked').value;
                const frequencyName = frequency.charAt(0).toUpperCase() + frequency.slice(1);
                nameField.value = `${frequencyName} ${scriptName}`;
            }
        }
    }
});

// Start date helper functions
function setStartDate(type) {
    const startDateField = document.getElementById('start_date');
    const today = new Date();
    
    switch(type) {
        case 'today':
            startDateField.value = today.toISOString().split('T')[0];
            break;
        case 'tomorrow':
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            startDateField.value = tomorrow.toISOString().split('T')[0];
            break;
        case 'next_week':
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            startDateField.value = nextWeek.toISOString().split('T')[0];
            break;
    }
    updatePreview();
}

function updateFrequencyOptions() {
    const frequency = document.querySelector('input[name="frequency"]:checked').value;
    const weeklyOptions = document.getElementById('weekly_options');
    const monthlyOptions = document.getElementById('monthly_options');
    
    // Hide all frequency-specific options
    weeklyOptions.style.display = 'none';
    monthlyOptions.style.display = 'none';
    
    // Show relevant options
    if (frequency === 'weekly') {
        weeklyOptions.style.display = 'block';
    } else if (frequency === 'monthly') {
        monthlyOptions.style.display = 'block';
    }
}

function updatePreview() {
    const frequency = document.querySelector('input[name="frequency"]:checked').value;
    const time = document.getElementById('time').value;
    const startDate = document.getElementById('start_date').value;
    const preview = document.getElementById('schedule_preview');
    
    let previewText = '';
    let startText = '';
    
    // Add start date info if specified
    if (startDate) {
        const startDateObj = new Date(startDate);
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        
        if (startDate === today.toISOString().split('T')[0]) {
            startText = ' starting today';
        } else if (startDate === tomorrow.toISOString().split('T')[0]) {
            startText = ' starting tomorrow';
        } else {
            startText = ` starting ${startDateObj.toLocaleDateString()}`;
        }
    }
    
    if (frequency === 'daily') {
        previewText = `This schedule will run daily at ${time}${startText}`;
    } else if (frequency === 'weekly') {
        const checkedDays = Array.from(document.querySelectorAll('input[name="days"]:checked'))
            .map(cb => cb.value)
            .map(day => day.charAt(0).toUpperCase() + day.slice(1));
        
        if (checkedDays.length === 0) {
            previewText = `Please select at least one day of the week`;
        } else if (checkedDays.length === 1) {
            previewText = `This schedule will run every ${checkedDays[0]} at ${time}${startText}`;
        } else {
            previewText = `This schedule will run on ${checkedDays.join(', ')} at ${time}${startText}`;
        }
    } else if (frequency === 'monthly') {
        const day = document.getElementById('day').value || '1';
        const suffix = getDaySuffix(day);
        previewText = `This schedule will run on the ${day}${suffix} of each month at ${time}${startText}`;
    }
    
    preview.textContent = previewText;
}

function getDaySuffix(day) {
    const j = day % 10;
    const k = day % 100;
    
    if (j == 1 && k != 11) {
        return 'st';
    }
    if (j == 2 && k != 12) {
        return 'nd';
    }
    if (j == 3 && k != 13) {
        return 'rd';
    }
    return 'th';
}

// Auto-populate schedule name based on script selection
document.getElementById('script_id').addEventListener('change', function() {
    const nameField = document.getElementById('name');
    if (!nameField.value && this.selectedOptions[0]) {
        const scriptName = this.selectedOptions[0].text.split('] ')[1]; // Remove [PY] or [BAT] prefix
        const frequency = document.querySelector('input[name="frequency"]:checked').value;
        const frequencyName = frequency.charAt(0).toUpperCase() + frequency.slice(1);
        nameField.value = `${frequencyName} ${scriptName}`;
    }
});

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFrequencyOptions();
    updatePreview();
});
</script>
{% endblock %}