{% extends "base.html" %}

{% block title %}Edit Schedule - ScriptFlow{% endblock %}

{% block extra_css %}
<style>
    /* Quick start buttons */
    .btn-outline-secondary.btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Edit Schedule</h1>
                    <p class="text-muted">Modify automated script execution settings</p>
                </div>
                <a href="{{ url_for('schedules') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Schedules
                </a>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <form method="POST">
                                <!-- Basic Settings -->
                                <div class="mb-4">
                                    <h5 class="card-title">
                                        <i class="bi bi-gear me-2"></i>Basic Settings
                                    </h5>
                                    <hr>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="script_id" class="form-label">Script *</label>
                                            <select class="form-select" id="script_id" name="script_id" required>
                                                {% for script in scripts %}
                                                <option value="{{ script.id }}" 
                                                        {% if script.id == schedule.script_id %}selected{% endif %}>
                                                    [{{ script.script_type.upper() }}] {{ script.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="name" class="form-label">Schedule Name *</label>
                                            <input type="text" class="form-control" id="name" name="name" 
                                                   value="{{ schedule.name }}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"
                                              placeholder="Optional description of what this schedule does...">{{ schedule.description or '' }}</textarea>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                               {% if schedule.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="is_active">
                                            <strong>Active Schedule</strong>
                                            <small class="d-block text-muted">Enable this schedule to run automatically</small>
                                        </label>
                                    </div>
                                </div>

                                <!-- Schedule Pattern -->
                                <div class="mb-4">
                                    <h5 class="card-title">
                                        <i class="bi bi-calendar3 me-2"></i>Schedule Pattern
                                    </h5>
                                    <hr>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Frequency *</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" 
                                                       id="frequency_daily" value="daily"
                                                       {% if schedule.frequency == 'daily' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_daily">
                                                    <i class="bi bi-calendar-day me-1"></i>Daily
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" 
                                                       id="frequency_weekly" value="weekly"
                                                       {% if schedule.frequency == 'weekly' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_weekly">
                                                    <i class="bi bi-calendar-week me-1"></i>Weekly
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" 
                                                       id="frequency_monthly" value="monthly"
                                                       {% if schedule.frequency == 'monthly' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_monthly">
                                                    <i class="bi bi-calendar-month me-1"></i>Monthly
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="frequency" 
                                                       id="frequency_interval" value="interval"
                                                       {% if schedule.frequency == 'interval' %}checked{% endif %}>
                                                <label class="form-check-label" for="frequency_interval">
                                                    <i class="bi bi-clock me-1"></i>Interval
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="time" class="form-label">Time *</label>
                                            <input type="time" class="form-control" id="time" name="time" 
                                                   value="{{ schedule.time_config_json.get('time', '09:00') }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="start_date" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="start_date" name="start_date"
                                                   value="{{ schedule.time_config_json.get('start_date', '') }}">
                                            <small class="text-muted">Leave empty to use current schedule</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Quick Start</label>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setStartDate('today')">Today</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="setStartDate('tomorrow')">Tomorrow</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setStartDate('next_week')">Next Week</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weekly Options -->
                                <div id="weekly_options" class="mb-3">
                                    <label class="form-label">Days of Week *</label>
                                    <div class="row">
                                        {% set current_days = schedule.time_config_json.get('days', ['monday']) %}
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="monday" id="day_monday"
                                                       {% if 'monday' in current_days %}checked{% endif %}>
                                                <label class="form-check-label" for="day_monday">Mon</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="tuesday" id="day_tuesday"
                                                       {% if 'tuesday' in current_days %}checked{% endif %}>
                                                <label class="form-check-label" for="day_tuesday">Tue</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="wednesday" id="day_wednesday"
                                                       {% if 'wednesday' in current_days %}checked{% endif %}>
                                                <label class="form-check-label" for="day_wednesday">Wed</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="thursday" id="day_thursday"
                                                       {% if 'thursday' in current_days %}checked{% endif %}>
                                                <label class="form-check-label" for="day_thursday">Thu</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="friday" id="day_friday"
                                                       {% if 'friday' in current_days %}checked{% endif %}>
                                                <label class="form-check-label" for="day_friday">Fri</label>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="saturday" id="day_saturday"
                                                       {% if 'saturday' in current_days %}checked{% endif %}>
                                                <label class="form-check-label" for="day_saturday">Sat</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="days" 
                                                       value="sunday" id="day_sunday"
                                                       {% if 'sunday' in current_days %}checked{% endif %}>
                                                <label class="form-check-label" for="day_sunday">Sun</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Monthly Options -->
                                <div id="monthly_options" class="mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="day" class="form-label">Day of Month *</label>
                                            <input type="number" class="form-control" id="day" name="day" 
                                                   value="{{ schedule.time_config_json.get('day', 1) }}" min="1" max="28">
                                            <small class="text-muted">Day 1-28 (to avoid month-end issues)</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Interval Options -->
                                <div id="interval_options" class="mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="interval_minutes" class="form-label">Interval *</label>
                                            <select class="form-control" id="interval_minutes" name="interval_minutes">
                                                {% set current_interval = schedule.time_config_json.get('interval_minutes', '15') %}
                                                <option value="1" {% if current_interval == '1' or current_interval == 1 %}selected{% endif %}>Every 1 minute</option>
                                                <option value="5" {% if current_interval == '5' or current_interval == 5 %}selected{% endif %}>Every 5 minutes</option>
                                                <option value="10" {% if current_interval == '10' or current_interval == 10 %}selected{% endif %}>Every 10 minutes</option>
                                                <option value="15" {% if current_interval == '15' or current_interval == 15 %}selected{% endif %}>Every 15 minutes</option>
                                                <option value="20" {% if current_interval == '20' or current_interval == 20 %}selected{% endif %}>Every 20 minutes</option>
                                                <option value="25" {% if current_interval == '25' or current_interval == 25 %}selected{% endif %}>Every 25 minutes</option>
                                                <option value="30" {% if current_interval == '30' or current_interval == 30 %}selected{% endif %}>Every 30 minutes</option>
                                                <option value="35" {% if current_interval == '35' or current_interval == 35 %}selected{% endif %}>Every 35 minutes</option>
                                                <option value="40" {% if current_interval == '40' or current_interval == 40 %}selected{% endif %}>Every 40 minutes</option>
                                                <option value="45" {% if current_interval == '45' or current_interval == 45 %}selected{% endif %}>Every 45 minutes</option>
                                                <option value="50" {% if current_interval == '50' or current_interval == 50 %}selected{% endif %}>Every 50 minutes</option>
                                                <option value="55" {% if current_interval == '55' or current_interval == 55 %}selected{% endif %}>Every 55 minutes</option>
                                                <option value="60" {% if current_interval == '60' or current_interval == 60 %}selected{% endif %}>Every 1 hour</option>
                                            </select>
                                            <small class="text-muted">Script will run continuously at this interval</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Current Schedule Info -->
                                <div class="mb-4">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-info-circle me-2"></i>Current Schedule
                                        </h6>
                                        <p class="mb-1"><strong>Frequency:</strong> {{ schedule.frequency_display }}</p>
                                        {% if schedule.next_run_time %}
                                        <p class="mb-0"><strong>Next Run:</strong> {{ schedule.next_run_display }}</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Preview Section -->
                                <div class="mb-4">
                                    <div class="alert alert-success">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-calendar-check me-2"></i>Updated Schedule Preview
                                        </h6>
                                        <p class="mb-0" id="schedule_preview">
                                            This schedule will run {{ schedule.frequency }} at {{ schedule.time_config_json.get('time', '09:00') }}
                                        </p>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-save me-2"></i>Save Changes
                                    </button>
                                    <a href="{{ url_for('schedules') }}" class="btn btn-outline-secondary">
                                        Cancel
                                    </a>
                                    <form method="POST" action="{{ url_for('delete_schedule', schedule_id=schedule.id) }}" 
                                          style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this schedule?')">
                                        <button type="submit" class="btn btn-outline-danger ms-auto">
                                            <i class="bi bi-trash me-2"></i>Delete Schedule
                                        </button>
                                    </form>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle frequency changes
document.addEventListener('change', function(e) {
    if (e.target.name === 'frequency') {
        updateFrequencyOptions();
        updatePreview();
    }
    if (e.target.name === 'days' || e.target.name === 'time' || e.target.id === 'day' || e.target.id === 'start_date' || e.target.id === 'interval_minutes') {
        updatePreview();
    }
});

function updateFrequencyOptions() {
    const frequency = document.querySelector('input[name="frequency"]:checked').value;
    const weeklyOptions = document.getElementById('weekly_options');
    const monthlyOptions = document.getElementById('monthly_options');
    const intervalOptions = document.getElementById('interval_options');
    const timeField = document.getElementById('time').closest('.mb-3');
    const startDateField = document.getElementById('start_date').closest('.mb-3');
    
    // Hide all frequency-specific options
    weeklyOptions.style.display = 'none';
    monthlyOptions.style.display = 'none';
    intervalOptions.style.display = 'none';
    
    // Show relevant options and hide/show time fields
    if (frequency === 'weekly') {
        weeklyOptions.style.display = 'block';
        timeField.style.display = 'block';
        startDateField.style.display = 'block';
    } else if (frequency === 'monthly') {
        monthlyOptions.style.display = 'block';
        timeField.style.display = 'block';
        startDateField.style.display = 'block';
    } else if (frequency === 'interval') {
        intervalOptions.style.display = 'block';
        timeField.style.display = 'block'; // Show time field for intervals - user needs to specify start time
        startDateField.style.display = 'block';
    } else {
        // Daily frequency
        timeField.style.display = 'block';
        startDateField.style.display = 'block';
    }
}

function updatePreview() {
    const frequency = document.querySelector('input[name="frequency"]:checked').value;
    const time = document.getElementById('time').value;
    const startDate = document.getElementById('start_date').value;
    const preview = document.getElementById('schedule_preview');
    
    let previewText = '';
    let startText = '';
    
    // Add start date info if specified
    if (startDate) {
        const startDateObj = new Date(startDate + 'T00:00:00'); // Force local timezone
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        
        // Get date strings in YYYY-MM-DD format for comparison
        const todayStr = today.getFullYear() + '-' + 
                        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(today.getDate()).padStart(2, '0');
        const tomorrowStr = tomorrow.getFullYear() + '-' + 
                           String(tomorrow.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(tomorrow.getDate()).padStart(2, '0');
        
        if (startDate === todayStr) {
            startText = ' starting today';
        } else if (startDate === tomorrowStr) {
            startText = ' starting tomorrow';
        } else {
            // Format date as DD/MM/YYYY for display
            const day = String(startDateObj.getDate()).padStart(2, '0');
            const month = String(startDateObj.getMonth() + 1).padStart(2, '0');
            const year = startDateObj.getFullYear();
            startText = ` starting ${day}/${month}/${year}`;
        }
    }
    
    if (frequency === 'daily') {
        previewText = `This schedule will run daily at ${time}${startText}`;
    } else if (frequency === 'weekly') {
        const checkedDays = Array.from(document.querySelectorAll('input[name="days"]:checked'))
            .map(cb => cb.value)
            .map(day => day.charAt(0).toUpperCase() + day.slice(1));
        
        if (checkedDays.length === 0) {
            previewText = `Please select at least one day of the week`;
        } else if (checkedDays.length === 1) {
            previewText = `This schedule will run every ${checkedDays[0]} at ${time}${startText}`;
        } else {
            previewText = `This schedule will run on ${checkedDays.join(', ')} at ${time}${startText}`;
        }
    } else if (frequency === 'monthly') {
        const day = document.getElementById('day').value || '1';
        const suffix = getDaySuffix(day);
        previewText = `This schedule will run on the ${day}${suffix} of each month at ${time}${startText}`;
    } else if (frequency === 'interval') {
        const intervalMinutes = document.getElementById('interval_minutes').value || '15';
        let intervalText = '';
        if (intervalMinutes === '60') {
            intervalText = 'every hour';
        } else {
            intervalText = `every ${intervalMinutes} minutes`;
        }
        
        let timeText = '';
        if (startDate || time !== '09:00') {
            timeText = ` beginning at ${time}`;
        }
        
        previewText = `This schedule will run ${intervalText}${timeText}${startText}`;
    }
    
    preview.textContent = previewText;
}

function getDaySuffix(day) {
    const j = day % 10;
    const k = day % 100;
    
    if (j == 1 && k != 11) {
        return 'st';
    }
    if (j == 2 && k != 12) {
        return 'nd';
    }
    if (j == 3 && k != 13) {
        return 'rd';
    }
    return 'th';
}

// Start date helper functions
function setStartDate(type) {
    const startDateField = document.getElementById('start_date');
    const today = new Date();
    
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    switch(type) {
        case 'today':
            startDateField.value = formatDateForInput(today);
            break;
        case 'tomorrow':
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            startDateField.value = formatDateForInput(tomorrow);
            break;
        case 'next_week':
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            startDateField.value = formatDateForInput(nextWeek);
            break;
    }
    updatePreview();
}

// Initialize frequency options and preview on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFrequencyOptions();
    updatePreview();
});
</script>
{% endblock %}